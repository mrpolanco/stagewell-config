name: Update Challenge Stats

on:
    schedule:
      # Run daily at 2 AM UTC
      - cron: '0 2 * * *'
    workflow_dispatch: # Allow manual trigger

jobs:
    update-stats:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v4

        - name: Set up Python
          uses: actions/setup-python@v5
          with:
            python-version: '3.11'

        - name: Install dependencies
          run: pip install requests

        - name: Query PostHog and update stats
          env:
            POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
            POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }}
          run: python scripts/update_stats.py

        - name: Setup SSH
          uses: webfactory/ssh-agent@v0.8.0
          with:
            ssh-private-key: ${{ secrets.STATS_DEPLOY_KEY }}

        - name: Push stats
          run: |
            git remote set-url origin git@github.com:mrpolanco/stagewell-config.git
            git config --local user.email "github-actions[bot]@users.noreply.github.com"
            git config --local user.name "github-actions[bot]"
            git add config/stats.json
            git diff --staged --quiet || git commit -m "Update challenge stats [automated]"
            git push
